<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>EcoLearn ‚Äî Gamified Environmental Education</title>
<style>
  :root{
    --bg1:#dff7d6;
    --bg2:#b6e07f;
    --accent:#56ab2f;
    --dark:#21421b;
    --muted:#8dbb75;
    --card:#f0fbe9;
  }
  *{box-sizing:border-box;font-family: "Segoe UI", Roboto, system-ui, -apple-system, "Helvetica Neue", Arial;}
  body{
    margin:0;
    min-height:100vh;
    background: linear-gradient(180deg,#eaf8d9 0%, #bfe57a 100%);
    display:flex;
    align-items:stretch;
    color:var(--dark);
  }

  /* Container */
  .app {
    width:100%;
    max-width:1100px;
    margin:32px auto;
    display:flex;
    gap:18px;
    padding:18px;
    align-items:flex-start;
  }

  /* Sidebar */
  .sidebar {
    width:200px;
    background:linear-gradient(180deg, #cfefb0, #b6e07f);
    border-radius:14px;
    padding:18px;
    box-shadow:0 8px 24px rgba(21,64,12,0.08);
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  .brand { font-weight:800; font-size:20px; color:var(--dark); text-align:center; padding:6px 0; }
  .nav-btn {
    appearance:none;
    border: none;
    background:var(--card);
    color:var(--dark);
    padding:10px 12px;
    border-radius:24px;
    cursor:pointer;
    font-weight:700;
    box-shadow:0 3px 8px rgba(0,0,0,0.06);
    transition: all .18s ease;
  }
  .nav-btn.active { background:var(--accent); color:#fff; box-shadow:0 6px 18px rgba(37,99,22,0.18); transform:translateY(-2px); }
  .nav-btn.logout { background:#e46b6b; color:#fff; border-color: #b93a3a; }

  .sidebar .small { font-size:12px; color:rgba(0,0,0,0.5); text-align:center; margin-top:6px; }

  /* Main area */
  .main {
    flex:1;
    display:flex;
    flex-direction:column;
    gap:14px;
  }

  .card {
    background:var(--card);
    border-radius:14px;
    padding:18px;
    box-shadow: inset 0 0 40px 4px rgba(158,210,118,0.12);
  }

  /* Dashboard top */
  .top-row { display:flex; justify-content:space-between; align-items:center; gap:12px; }
  .welcome { font-size:20px; font-weight:800; color:var(--dark); }
  .stats { display:flex; gap:10px; align-items:center; }
  .stat-bubble { background:linear-gradient(180deg,#fff,#e6f8de); padding:8px 12px; border-radius:999px; font-weight:700; box-shadow:0 3px 10px rgba(0,0,0,0.06); }

  /* Content sections */
  .section { display:none; }
  .section.active { display:block; }

  /* Learn layout */
  .domains-grid { display:flex; gap:12px; flex-wrap:wrap; margin-top:12px; }
  .domain-card {
    flex: 1 1 calc(50% - 12px);
    min-width:140px;
    background: linear-gradient(180deg,#e8f8d9,#cfeeb0);
    padding:12px;
    border-radius:12px;
    cursor:pointer;
    box-shadow:0 6px 18px rgba(0,0,0,0.04);
    font-weight:700;
    text-align:center;
    transition: all .16s ease;
  }
  .domain-card:hover { transform:translateY(-6px); box-shadow:0 10px 22px rgba(0,0,0,0.08); }
  .domain-selected { outline:3px solid rgba(86,171,47,0.14); }

  /* Split area for topic */
  .split {
    display:flex;
    gap:16px;
    margin-top:10px;
    align-items:stretch;
  }
  .left {
    flex:1;
    min-width:220px;
    background:linear-gradient(180deg,#f6fff0,#e9f7d6);
    border-radius:12px;
    padding:14px;
  }
  .right {
    width:460px;
    max-width:46%;
    min-width:280px;
    background:linear-gradient(180deg,#f7fff8,#e9fdf0);
    border-radius:12px;
    padding:12px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:8px;
  }
  .topic-title { font-size:18px; font-weight:800; margin-bottom:6px; color:var(--dark); }
  .topic-text { color:#2e4e2a; line-height:1.5; }

  /* Canvas styling */
  canvas { border-radius:10px; background: linear-gradient(180deg,#08130a,#07200e); box-shadow:0 6px 18px rgba(0,0,0,0.25); display:block; }

  /* Quiz, Badge, Leaderboard */
  .quiz-options { display:flex; flex-direction:column; gap:10px; margin-top:10px; }
  .opt { padding:10px 12px; border-radius:10px; background:#dff0c9; cursor:pointer; font-weight:700; border:2px solid rgba(0,0,0,0.03); }
  .opt.correct { background:#4caf50; color:white; }
  .opt.wrong { background:#e34b4b; color:white; }

  .badges-list { display:flex; gap:12px; flex-wrap:wrap; margin-top:10px; }
  .badge { width:72px; height:72px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:22px; background:linear-gradient(180deg,#86c04a,#5aa02a); color:#fff; box-shadow:0 6px 18px rgba(0,0,0,0.12); }

  .leaderboard-list { margin-top:10px; }
  .leader-item { display:flex; justify-content:space-between; padding:8px 10px; background:linear-gradient(180deg,#fff,#f0fff0); border-radius:8px; margin-bottom:8px; }

  /* Responsive */
  @media(max-width:980px){
    .app{ padding:12px; gap:10px; }
    .sidebar{ display:flex; flex-direction:row; width:100%; justify-content:space-between; padding:10px; border-radius:12px; }
    .main{ width:100%; }
    .split{ flex-direction:column; }
    .right{ width:100%; max-width:100%; }
  }
</style>
</head>
<body>
  <div class="app" role="application" aria-label="EcoLearn app">
    <!-- Sidebar -->
    <aside class="sidebar" aria-label="Navigation">
      <div class="brand">EcoLearn</div>
      <button class="nav-btn active" data-target="dash">About</button>
      <button class="nav-btn" data-target="learn">Learn</button>
      <button class="nav-btn" data-target="quiz">Quiz</button>
      <button class="nav-btn" data-target="badges">Badges</button>
      <button class="nav-btn" data-target="leaderboard">Leaderboard</button>
      <button class="nav-btn" data-target="reader">Reader</button>
      <div style="flex:1"></div>
      <div class="small">Logged in as <strong id="userLabel">Guest</strong></div>
      <button class="nav-btn logout" id="logoutBtn">Logout</button>
    </aside>

    <!-- Main -->
    <main class="main">
      <!-- Top card -->
      <section class="card top-row" aria-hidden="false">
        <div>
          <div class="welcome">Welcome to EcoLearn</div>
          <div style="color:rgba(0,0,0,0.55); margin-top:6px;">Learn concepts, play mini-games, and earn eco-points & badges.</div>
        </div>
        <div class="stats">
          <div class="stat-bubble">Eco Points: <span id="ecoPoints">0</span></div>
          <div class="stat-bubble">Badges: <span id="badgeCount">0</span></div>
        </div>
      </section>

      <!-- Dashboard section -->
      <section id="dash" class="card section active" aria-labelledby="dash">
        <h3>Dashboard</h3>
        <p>This is SIH project made by six people.</p>

      </section>

      <!-- Learn section -->
      <section id="learn" class="card section" aria-labelledby="learn">
        <h3>Learn</h3>
        <p>Select a topic to open the info + game split layout.</p>

        <div class="domains-grid" role="list" aria-label="domains">
          <div class="domain-card" role="listitem" data-sub="water">üíß Water Conservation</div>
          <div class="domain-card" role="listitem" data-sub="agriculture">üå± Sustainable Agriculture</div>
          <div class="domain-card" role="listitem" data-sub="energy">üîã Renewable Energy</div>
          <div class="domain-card" role="listitem" data-sub="forest">üå≥ Forest Diversity (info)</div>
        </div>

        <!-- Split area (info + game) -->
        <div id="topicArea" style="margin-top:14px; display:none;">
          <div class="split">
            <div class="left">
              <div class="topic-title" id="topicTitle">Topic</div>
              <div class="topic-text" id="topicText">Topic description appears here.</div>
              <div style="margin-top:12px;">
                <button id="markLearned" class="nav-btn" style="background:var(--accent); color:#fff;">Mark as Learned (+10 points)</button>
              </div>
            </div>
            <div class="right">
              <div style="font-weight:800; color:var(--dark);">Play & Practice</div>
              <canvas id="gameCanvas" width="300" height="320" aria-label="Game canvas"></canvas>
              <div style="font-size:13px; color:rgba(0,0,0,0.6);" id="gameHelp">Controls: ...</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Quiz -->
      <section id="quiz" class="card section" aria-labelledby="quiz">
        <h3>Quick Quiz</h3>
        <div id="quizArea">
          <p style="opacity:.8">Click the Quiz tab to start.</p>
        </div>
      </section>

      <!-- Badges -->
      <section id="badges" class="card section" aria-labelledby="badges">
        <h3>Your Badges</h3>
        <div class="badges-list" id="badgesList"></div>
      </section>

      <!-- Leaderboard -->
      <section id="leaderboard" class="card section" aria-labelledby="leaderboard">
        <h3>Leaderboard</h3>
        <div class="leaderboard-list" id="leaderboardList"></div>
      </section>

      <!-- Reader -->
      <section id="reader" class="card section" aria-labelledby="reader">
        <h3>Reader</h3>
        <div style="font-style:italic; color:#2e471e;">
          <p>‚ÄúThe Earth is what we all have in common.‚Äù ‚Äî Wendell Berry</p>
          <ul>
            <li>Rainwater harvesting, efficient irrigation & leak fixing.</li>
            <li>Crop rotation, organic fertilizers & low tillage farming.</li>
            <li>Solar panels, micro wind turbines and energy conservation.</li>
          </ul>
        </div>
      </section>

    </main>
  </div>

<script>
/* ----------------------
   App state & persistence
   ---------------------- */
const DEFAULT_USER = { name: 'Guest' };
let user = JSON.parse(localStorage.getItem('ecolearn_user')) || DEFAULT_USER;
let ecoPoints = Number(localStorage.getItem('ecolearn_points')) || 0;
let badges = JSON.parse(localStorage.getItem('ecolearn_badges') || '[]');
let leaderboard = JSON.parse(localStorage.getItem('ecolearn_leaderboard') || '{}');

const navButtons = document.querySelectorAll('.sidebar .nav-btn:not(.logout)');
const logoutBtn = document.getElementById('logoutBtn');
const sections = document.querySelectorAll('.section');
const userLabel = document.getElementById('userLabel');
const pointsLabel = document.getElementById('ecoPoints');
const badgeCount = document.getElementById('badgeCount');

userLabel.textContent = user.name;
pointsLabel.textContent = ecoPoints;
badgeCount.textContent = badges.length;

function persist() {
  localStorage.setItem('ecolearn_points', ecoPoints);
  localStorage.setItem('ecolearn_badges', JSON.stringify(badges));
  localStorage.setItem('ecolearn_leaderboard', JSON.stringify(leaderboard));
  localStorage.setItem('ecolearn_user', JSON.stringify(user));
}

/* ----------------------
   Sidebar nav handling
   ---------------------- */
navButtons.forEach(btn=>{
  btn.addEventListener('click', ()=> {
    navButtons.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const t = btn.dataset.target;
    showSection(t);
    // special actions
    if(t === 'quiz') initQuiz();
    if(t === 'badges') renderBadges();
    if(t === 'leaderboard') renderLeaderboard();
  });
});
logoutBtn.addEventListener('click', ()=>{
  if(confirm('Logout? This will clear local progress.')) {
    localStorage.removeItem('ecolearn_user');
    localStorage.removeItem('ecolearn_points');
    localStorage.removeItem('ecolearn_badges');
    localStorage.removeItem('ecolearn_leaderboard');
    location.reload();
  }
});

function showSection(id){
  sections.forEach(s=>s.classList.remove('active'));
  const sec = document.getElementById(id);
  if(sec) sec.classList.add('active');
}

/* ----------------------
   Dashboard quick links
   ---------------------- */
document.querySelectorAll('.domain-quick').forEach(btn=>{
  btn.addEventListener('click', ()=> {
    // show learn section and select topic
    document.querySelector('.nav-btn[data-target="learn"]').click();
    const sub = btn.dataset.sub;
    // small delay to ensure learn section visible
    setTimeout(()=> openTopic(sub), 50);
  });
});

/* ----------------------
   Learn topics content
   ---------------------- */
const topics = {
  water: {
    title: 'Water Conservation',
    text: `What is Water Conservation?,
'Use water efficiently to reduce waste and protect resources.
Why it's important:
- Ensures water availability
- Protects ecosystems
- Saves energy and money`
  },
  agriculture: {
    title: 'Sustainable Agriculture',
    text: `Sustainable Agriculture:
Practices that protect soil health and biodiversity.
Why it's important:
- Long-term food security
- Reduces chemical pollution`
  },
  energy: {
    title: 'Renewable Energy',
    text: `Renewable Energy:
Solar, wind and hydro sources reduce carbon emissions.
Why it's important:
- Reduces pollution
- Sustainable power supply`
  },
  forest: {
    title: 'Forest Diversity',
    text: `Forests provide habitat, clean air & climate regulation.
Protecting forest diversity preserves ecosystems and species.`
  }
};

const domainCards = document.querySelectorAll('.domain-card');
const topicArea = document.getElementById('topicArea');
const topicTitle = document.getElementById('topicTitle');
const topicText = document.getElementById('topicText');
const markLearnedBtn = document.getElementById('markLearned');
const gameHelp = document.getElementById('gameHelp');

domainCards.forEach(card=>{
  card.addEventListener('click', ()=> {
    const sub = card.dataset.sub;
    openTopic(sub);
  });
});

function openTopic(sub){
  if(!topics[sub]) return;
  // show split
  topicArea.style.display = 'block';
  topicTitle.textContent = topics[sub].title;
  topicText.textContent = topics[sub].text;
  // choose game based on topic
  currentTopic = sub;
  stopGameIfAny();
  initGameForTopic(sub);
  // scroll into view
  topicArea.scrollIntoView({behavior:'smooth', block:'start'});
}

/* ----------------------
   Mark learned
   ---------------------- */
markLearnedBtn.addEventListener('click', ()=>{
  earnPoints(10);
  addBadgeOnce('Eco Learner');
  alert('Marked as learned! +10 points');
});

/* ----------------------
   Points & badges helpers
   ---------------------- */
function earnPoints(n){
  ecoPoints += n;
  pointsLabel.textContent = ecoPoints;
  // update leaderboard for default user
  if(!leaderboard[user.name]) leaderboard[user.name] = 0;
  leaderboard[user.name] = ecoPoints;
  persist();
  renderLeaderboard();
  updateBadgeStatus();
}
function addBadgeOnce(name){
  if(!badges.includes(name)){
    badges.push(name);
    badgeCount.textContent = badges.length;
    persist();
  }
}
function updateBadgeStatus(){
  // Example auto badges
  if(ecoPoints >= 5) addBadgeOnce('Water Saver');
  if(ecoPoints >= 15) addBadgeOnce('Green Farmer');
  if(ecoPoints >= 30) addBadgeOnce('Eco Quizzer');
  if(ecoPoints >= 40) addBadgeOnce('Energy Hero');
  if(ecoPoints >= 50) addBadgeOnce('Forest Guardian');
}

/* ----------------------
   Games: manage lifecycle
   ---------------------- */
let gameCanvas = document.getElementById('gameCanvas');
let gameCtx = null;
let gameLoopId = null;
let currentTopic = null;

/* stop any running game */
function stopGameIfAny(){
  if(gameLoopId) {
    cancelAnimationFrame(gameLoopId);
    gameLoopId = null;
  }
  window.removeEventListener('keydown', globalKeyHandler);
  // cancel snake timer if used
  if(window._snakeTimer) { clearTimeout(window._snakeTimer); window._snakeTimer = null; }
}

/* init correct game */
function initGameForTopic(topic){
  // ensure canvas is present
  gameCanvas = document.getElementById('gameCanvas');
  gameCtx = gameCanvas.getContext('2d');
  // reset canvas clear
  gameCtx.clearRect(0,0,gameCanvas.width,gameCanvas.height);

  if(topic === 'water'){
    gameHelp.textContent = 'Controls: Left / Right arrows to move bucket. Catch drops (+2 pts)';
    initWaterGame();
  } else if(topic === 'agriculture'){
    gameHelp.textContent = 'Controls: Arrow keys to move snake. Eat crops (+5 pts)';
    initSnakeGame();
  } else if(topic === 'energy'){
    gameHelp.textContent = 'Controls: Left/Right to move rocket, Space to shoot. Pop balloons (+3 pts)';
    initRocketGame();
  } else { // forest or other: no game; show placeholder
    gameHelp.textContent = 'This topic currently shows information only.';
    gameCtx.fillStyle = '#0a290f';
    gameCtx.fillRect(0,0,gameCanvas.width,gameCanvas.height);
    gameCtx.fillStyle = '#9edb8a';
    gameCtx.font = '16px system-ui';
    gameCtx.fillText('No game for this topic', 20, 40);
  }
}

/* =========================
   WATER GAME (bucket)
   ========================= */
function initWaterGame(){
  stopGameIfAny();
  const ctx = gameCtx;
  const canvas = gameCanvas;
  const bucket = { x: (canvas.width/2)-40, y: canvas.height-48, w:80, h:34 };
  let drops = [];
  let lastSpawn = 0;

  function spawnDrop(){
    const x = 10 + Math.random()*(canvas.width-20);
    drops.push({ x, y: -8, r:8, vy: 2 + Math.random()*1.4 });
  }

  function drawBucket(){
    // bucket bowl
    ctx.fillStyle = '#6d4c41';
    ctx.fillRect(bucket.x-8, bucket.y-6, bucket.w+16, 10);
    ctx.fillStyle = '#8d6e63';
    ctx.fillRect(bucket.x, bucket.y, bucket.w, bucket.h-6);
    // handle
    ctx.strokeStyle = '#5d4037'; ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.arc(bucket.x + bucket.w/2, bucket.y-2, bucket.w/2 + 6, Math.PI, 0);
    ctx.stroke();
  }

  function loop(t){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    // spawn occasionally
    if(Math.random() < 0.04) spawnDrop();
    // draw drops
    for(let i = drops.length -1; i >= 0; i--){
      const d = drops[i];
      ctx.beginPath();
      ctx.fillStyle = '#00bfff';
      ctx.arc(d.x, d.y, d.r, 0, Math.PI*2);
      ctx.fill();
      // simple teardrop tail
      ctx.beginPath();
      ctx.moveTo(d.x-3, d.y+2);
      ctx.lineTo(d.x, d.y+8);
      ctx.strokeStyle = 'rgba(0,0,0,0.05)';
      ctx.stroke();

      d.y += d.vy;
      // collision with bucket
      const withinX = d.x >= bucket.x && d.x <= bucket.x + bucket.w;
      const hit = (d.y + d.r) >= bucket.y && withinX;
      if(hit){
        drops.splice(i,1);
        earnPoints(2);
      } else if(d.y - d.r > canvas.height){
        drops.splice(i,1);
      }
    }
    // draw bucket after drops
    drawBucket();
    gameLoopId = requestAnimationFrame(loop);
  }

  window.addEventListener('keydown', globalKeyHandler);
  function globalKeyHandler(e){
    if(e.key === 'ArrowLeft'){ bucket.x = Math.max(6, bucket.x - 18); }
    if(e.key === 'ArrowRight'){ bucket.x = Math.min(canvas.width - bucket.w - 6, bucket.x + 18); }
  }

  // start loop
  loop();
}

/* =========================
   SNAKE GAME (agriculture)
   ========================= */
function initSnakeGame(){
  stopGameIfAny();
  const canvas = gameCanvas;
  const ctx = gameCtx;
  const CELL = 20;
  const COLS = Math.floor(canvas.width / CELL);
  const ROWS = Math.floor(canvas.height / CELL);

  // grid-based snake
  let snake = [{x: Math.floor(COLS/2), y: Math.floor(ROWS/2)}];
  let dir = {x:1, y:0};
  let nextDir = {x:1, y:0};
  let food = spawnFood();
  window._snakeTimer = null;

  function spawnFood(){
    let fx, fy, tries = 0;
    do {
      fx = Math.floor(Math.random() * COLS);
      fy = Math.floor(Math.random() * ROWS);
      tries++;
      if(tries > 200) break;
    } while (snake.some(s => s.x === fx && s.y === fy));
    return {x: fx, y: fy};
  }

  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    // background subtle grid
    ctx.globalAlpha = 0.06;
    ctx.strokeStyle = '#ffffff';
    for(let c=0;c<COLS;c++){ ctx.beginPath(); ctx.moveTo(c*CELL,0); ctx.lineTo(c*CELL,ROWS*CELL); ctx.stroke(); }
    for(let r=0;r<ROWS;r++){ ctx.beginPath(); ctx.moveTo(0,r*CELL); ctx.lineTo(COLS*CELL,r*CELL); ctx.stroke(); }
    ctx.globalAlpha = 1;

    // draw snake
    snake.forEach((s, i) => {
      ctx.fillStyle = (i===0) ? '#2e7d32' : '#66bb6a';
      ctx.fillRect(s.x*CELL + 2, s.y*CELL + 2, CELL - 4, CELL - 4);
    });
    // draw food as crop emoji
    ctx.font = (CELL - 2) + 'px system-ui, emoji';
    ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
    ctx.fillText('üåΩ', food.x*CELL + CELL/2, food.y*CELL + CELL/2 + 1);
  }

  function step(){
    dir = nextDir;
    const head = { x: snake[0].x + dir.x, y: snake[0].y + dir.y };
    // collisions
    if(head.x < 0 || head.y < 0 || head.x >= COLS || head.y >= ROWS || snake.some((s,idx)=>idx>0 && s.x===head.x && s.y===head.y)){
      alert('Game Over ‚Äî Snake crashed');
      stopGameIfAny();
      return;
    }
    snake.unshift(head);
    if(head.x === food.x && head.y === food.y){
      earnPoints(5);
      food = spawnFood();
    } else {
      snake.pop();
    }
    draw();
    window._snakeTimer = setTimeout(step, Math.max(80, 170 - (snake.length-3)*4));
  }

  function onKey(e){
    if(e.key === 'ArrowUp' && dir.y !== 1) nextDir = {x:0,y:-1};
    if(e.key === 'ArrowDown' && dir.y !== -1) nextDir = {x:0,y:1};
    if(e.key === 'ArrowLeft' && dir.x !== 1) nextDir = {x:-1,y:0};
    if(e.key === 'ArrowRight' && dir.x !== -1) nextDir = {x:1,y:0};
  }

  window.addEventListener('keydown', onKey);
  step();
}

/* =========================
   ROCKET GAME (energy)
   ========================= */
function initRocketGame(){
  stopGameIfAny();
  const canvas = gameCanvas;
  const ctx = gameCtx;
  const rocket = { x: canvas.width/2 - 18, y: canvas.height - 64, w:36, h:44 };
  let bullets = [];
  let balloons = [];

  function spawnBalloon(){
    const r = 10 + Math.random()*14;
    balloons.push({ x: r + Math.random()*(canvas.width - 2*r), y: -r*2, r: r, vy: 0.7 + Math.random()*0.9 });
  }

  function drawRocket(){
    ctx.fillStyle = '#e53935';
    ctx.fillRect(rocket.x + 8, rocket.y + 12, rocket.w - 16, rocket.h - 16);
    ctx.fillStyle = '#c62828';
    ctx.fillRect(rocket.x, rocket.y + 24, 10, 14);
    ctx.fillRect(rocket.x + rocket.w - 10, rocket.y + 24, 10, 14);
    ctx.fillStyle = '#ef5350';
    ctx.beginPath();
    ctx.moveTo(rocket.x + rocket.w/2, rocket.y);
    ctx.lineTo(rocket.x, rocket.y + 12);
    ctx.lineTo(rocket.x + rocket.w, rocket.y + 12);
    ctx.closePath();
    ctx.fill();
  }

  function loop(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    // maybe spawn balloons
    if(Math.random() < 0.025) spawnBalloon();
    // draw bullets
    for(let i = bullets.length -1; i >= 0; i--){
      const b = bullets[i];
      ctx.fillStyle = '#ffd54f';
      ctx.fillRect(b.x - 2, b.y, 4, 10);
      b.y += b.vy;
      if(b.y < -12 || b.y > canvas.height + 20) bullets.splice(i,1);
    }
    // draw balloons
    for(let i = balloons.length -1; i >= 0; i--){
      const bl = balloons[i];
      bl.y += bl.vy;
      // balloon body
      ctx.beginPath();
      ctx.ellipse(bl.x, bl.y, bl.r*0.85, bl.r, 0, 0, Math.PI*2);
      ctx.fillStyle = '#ff8a65';
      ctx.fill();
      // string
      ctx.strokeStyle = 'rgba(255,255,255,0.7)';
      ctx.beginPath();
      ctx.moveTo(bl.x, bl.y + bl.r);
      ctx.lineTo(bl.x, bl.y + bl.r + 10);
      ctx.stroke();
      // off-screen cleanup
      if(bl.y - bl.r > canvas.height + 30) balloons.splice(i,1);
      else {
        // check bullet collision
        for(let j = bullets.length -1; j >= 0; j--){
          const bu = bullets[j];
          const dx = bu.x - bl.x;
          const dy = bu.y - bl.y;
          if(Math.sqrt(dx*dx + dy*dy) < bl.r + 6){
            // pop
            balloons.splice(i,1);
            bullets.splice(j,1);
            earnPoints(3);
            break;
          }
        }
      }
    }
    // draw rocket last (so it's on top)
    drawRocket();
    gameLoopId = requestAnimationFrame(loop);
  }

  function fire(){
    bullets.push({ x: rocket.x + rocket.w/2, y: rocket.y - 8, vy: -6, vx: 0 });
  }

  function onKey(e){
    if(e.key === 'ArrowLeft') rocket.x = Math.max(6, rocket.x - 14);
    if(e.key === 'ArrowRight') rocket.x = Math.min(canvas.width - rocket.w - 6, rocket.x + 14);
    if(e.code === 'Space' || e.key === ' ') fire();
  }

  window.addEventListener('keydown', onKey);
  loop();
}

/* Simple global key handler used by bucket controls (kept generic) */
function globalKeyHandler(e){
  // In this app, specific games attach their own handlers; this is a fallback
  // kept intentionally minimal.
}

/* ----------------------
   Quiz implementation
   ---------------------- */
const quizQuestions = [
  { q: "Which is a renewable energy source?", opts: ["Coal","Wind","Oil","Gas"], ans: 1 },
  { q: "What helps conserve water?", opts: ["Leaving taps running","Rainwater harvesting","Bathing long","Washing car daily"], ans: 1 },
  { q: "Sustainable agriculture aims to:", opts: ["Harm soil","Use more chemicals","Protect environment","Overuse water"], ans: 2 },
  { q: "Forest diversity supports:", opts: ["Less wildlife","More pollution","Wildlife habitats","Less rainfall"], ans: 2 }
];

let quizIndex = 0;
function initQuiz(){
  quizIndex = 0;
  renderQuiz();
}
function renderQuiz(){
  const area = document.getElementById('quizArea');
  area.innerHTML = '';
  if(quizIndex >= quizQuestions.length){
    area.innerHTML = `<h4>Quiz completed!</h4><p>Your eco-points: ${ecoPoints}</p>`;
    updateBadgeStatus();
    return;
  }
  const q = quizQuestions[quizIndex];
  const qEl = document.createElement('div'); qEl.className = 'topic-title'; qEl.textContent = q.q;
  const opts = document.createElement('div'); opts.className = 'quiz-options';
  q.opts.forEach((o, i)=>{
    const b = document.createElement('div'); b.className = 'opt'; b.textContent = o;
    b.addEventListener('click', ()=>{
      if(b.classList.contains('correct')||b.classList.contains('wrong')) return;
      if(i === q.ans){ b.classList.add('correct'); earnPoints(10); alert('Correct! +10 pts'); }
      else { b.classList.add('wrong'); alert('Wrong!'); }
      setTimeout(()=>{ quizIndex++; renderQuiz(); }, 800);
    });
    opts.appendChild(b);
  });
  area.appendChild(qEl); area.appendChild(opts);
}

/* ----------------------
   Badges & Leaderboard UI
   ---------------------- */
function renderBadges(){
  const container = document.getElementById('badgesList');
  container.innerHTML = '';
  if(badges.length === 0){
    container.innerHTML = '<div style="opacity:.8">No badges yet ‚Äî play and earn them!</div>';
    return;
  }
  badges.forEach(b=>{
    const el = document.createElement('div'); el.className = 'badge'; el.title = b; el.textContent = b[0] || 'üèÖ';
    container.appendChild(el);
  });
}

function renderLeaderboard(){
  const el = document.getElementById('leaderboardList');
  el.innerHTML = '';
  // ensure current user exists
  if(!leaderboard[user.name]) leaderboard[user.name] = ecoPoints;
  // sort
  const sorted = Object.entries(leaderboard).sort((a,b)=>b[1]-a[1]);
  sorted.forEach(([name,pts], idx)=>{
    const row = document.createElement('div'); row.className = 'leader-item';
    row.innerHTML = `<div style="font-weight:700">${idx+1}. ${name}</div><div>${pts} pts</div>`;
    el.appendChild(row);
  });
}

/* ----------------------
   Initialization
   ---------------------- */
(function initApp(){
  // basic user prompt on first load
  if(!user || !user.name || user.name === 'Guest'){
    // ask a name quickly
    const nn = prompt('Welcome to EcoLearn! Enter your name (or leave blank for Guest):');
    if(nn && nn.trim().length) {
      user = { name: nn.trim() };
      localStorage.setItem('ecolearn_user', JSON.stringify(user));
      document.querySelectorAll('.sidebar .nav-btn').forEach(b=>b.classList.remove('active'));
      document.querySelector('.sidebar .nav-btn[data-target="dash"]').classList.add('active');
    }
  }
  userLabel.textContent = user.name || 'Guest';
  pointsLabel.textContent = ecoPoints;
  badgeCount.textContent = badges.length;
  renderLeaderboard();
  // ensure first view is Dashboard
  showSection('dash');
})();
</script>
</body>
</html>





